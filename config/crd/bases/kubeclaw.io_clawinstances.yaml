---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.2
  name: clawinstances.kubeclaw.io
spec:
  group: kubeclaw.io
  names:
    kind: ClawInstance
    listKind: ClawInstanceList
    plural: clawinstances
    singular: clawinstance
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.activeAgentPods
      name: Active Agents
      type: integer
    - jsonPath: .status.totalAgentRuns
      name: Total Runs
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          ClawInstance is the Schema for the clawinstances API.
          It represents a per-user/per-tenant gateway configuration.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              ClawInstanceSpec defines the desired state of a ClawInstance.
              Each user or tenant gets a ClawInstance that declares their desired channels,
              agents, and policy bindings.
            properties:
              agents:
                description: Agent configuration.
                properties:
                  default:
                    description: Default is the default agent configuration.
                    properties:
                      baseURL:
                        description: |-
                          BaseURL overrides the provider's default API endpoint.
                          Use for OpenAI-compatible providers (GitHub Copilot, Azure OpenAI, Ollama, etc.).
                        type: string
                      model:
                        description: Model is the LLM model to use.
                        type: string
                      sandbox:
                        description: Sandbox configuration.
                        properties:
                          enabled:
                            description: Enabled indicates whether sandboxing is enabled.
                            type: boolean
                          image:
                            description: Image is the sandbox container image.
                            type: string
                          resources:
                            description: Resources for the sandbox container.
                            properties:
                              claims:
                                description: |-
                                  Claims lists the names of resources, defined in spec.resourceClaims,
                                  that are used by this container.

                                  This is an alpha field and requires enabling the
                                  DynamicResourceAllocation feature gate.

                                  This field is immutable. It can only be set for containers.
                                items:
                                  description: ResourceClaim references one entry
                                    in PodSpec.ResourceClaims.
                                  properties:
                                    name:
                                      description: |-
                                        Name must match the name of one entry in pod.spec.resourceClaims of
                                        the Pod where this field is used. It makes that resource available
                                        inside a container.
                                      type: string
                                    request:
                                      description: |-
                                        Request is the name chosen for a request in the referenced claim.
                                        If empty, everything from the claim is made available, otherwise
                                        only the result of this request.
                                      type: string
                                  required:
                                  - name
                                  type: object
                                type: array
                                x-kubernetes-list-map-keys:
                                - name
                                x-kubernetes-list-type: map
                              limits:
                                additionalProperties:
                                  anyOf:
                                  - type: integer
                                  - type: string
                                  pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                  x-kubernetes-int-or-string: true
                                description: |-
                                  Limits describes the maximum amount of compute resources allowed.
                                  More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                                type: object
                              requests:
                                additionalProperties:
                                  anyOf:
                                  - type: integer
                                  - type: string
                                  pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                  x-kubernetes-int-or-string: true
                                description: |-
                                  Requests describes the minimum amount of compute resources required.
                                  If Requests is omitted for a container, it defaults to Limits if that is explicitly specified,
                                  otherwise to an implementation-defined value. Requests cannot exceed Limits.
                                  More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                                type: object
                            type: object
                        required:
                        - enabled
                        type: object
                      subagents:
                        description: Subagents configuration.
                        properties:
                          maxChildrenPerAgent:
                            default: 3
                            description: MaxChildrenPerAgent is the maximum number
                              of children per agent.
                            type: integer
                          maxConcurrent:
                            default: 5
                            description: MaxConcurrent is the maximum number of concurrent
                              agent runs.
                            type: integer
                          maxDepth:
                            default: 2
                            description: MaxDepth is the maximum nesting depth for
                              sub-agents.
                            type: integer
                        type: object
                      thinking:
                        description: Thinking is the thinking mode (off, low, medium,
                          high).
                        type: string
                    required:
                    - model
                    type: object
                required:
                - default
                type: object
              authRefs:
                description: AuthRefs references secrets containing AI provider credentials.
                items:
                  description: SecretRef references a Kubernetes Secret.
                  properties:
                    secret:
                      description: Secret is the name of the Secret.
                      type: string
                  required:
                  - secret
                  type: object
                type: array
              memory:
                description: |-
                  Memory configures persistent memory for this instance.
                  When enabled, a MEMORY.md ConfigMap is managed and mounted into agent pods.
                properties:
                  enabled:
                    default: true
                    description: Enabled indicates whether persistent memory is active.
                    type: boolean
                  maxSizeKB:
                    default: 256
                    description: MaxSizeKB caps the memory ConfigMap size in kilobytes.
                    type: integer
                  systemPrompt:
                    description: |-
                      SystemPrompt is injected into every agent run for this instance
                      to instruct the agent on how to use memory.
                    type: string
                required:
                - enabled
                type: object
              channels:
                description: Channels this instance connects to.
                items:
                  description: ChannelSpec defines a channel connection.
                  properties:
                    configRef:
                      description: ConfigRef references the secret containing channel
                        credentials.
                      properties:
                        secret:
                          description: Secret is the name of the Secret.
                          type: string
                      required:
                      - secret
                      type: object
                    type:
                      description: Type is the channel type (telegram, whatsapp, discord,
                        slack).
                      type: string
                  required:
                  - configRef
                  - type
                  type: object
                type: array
              policyRef:
                description: PolicyRef references the ClawPolicy that applies to this
                  instance.
                type: string
              memory:
                description: |-
                  Memory configures persistent memory for this instance.
                  When enabled, a MEMORY.md ConfigMap is managed and mounted into agent pods.
                properties:
                  enabled:
                    description: Enabled indicates whether persistent memory is active.
                    default: true
                    type: boolean
                  maxSizeKB:
                    description: MaxSizeKB caps the memory ConfigMap size in kilobytes.
                    default: 256
                    type: integer
                  systemPrompt:
                    description: |-
                      SystemPrompt is injected into every agent run for this instance
                      to instruct the agent on how to use memory.
                    type: string
                required:
                - enabled
                type: object
              skills:
                description: Skills to mount (from SkillPack CRDs or ConfigMaps).
                items:
                  description: SkillRef references a SkillPack or ConfigMap containing
                    skills.
                  properties:
                    configMapRef:
                      description: ConfigMapRef references a ConfigMap by name.
                      type: string
                    skillPackRef:
                      description: SkillPackRef references a SkillPack CRD by name.
                      type: string
                  type: object
                type: array
            required:
            - agents
            type: object
          status:
            description: ClawInstanceStatus defines the observed state of ClawInstance.
            properties:
              activeAgentPods:
                description: ActiveAgentPods is the number of currently running agent
                  pods.
                type: integer
              channels:
                description: Channels reports the status of each connected channel.
                items:
                  description: ChannelStatus reports the status of a channel.
                  properties:
                    lastHealthCheck:
                      description: LastHealthCheck is the timestamp of the last health
                        check.
                      format: date-time
                      type: string
                    message:
                      description: Message provides additional details about the channel
                        status.
                      type: string
                    status:
                      description: Status is the connection status (Connected, Disconnected,
                        Error).
                      type: string
                    type:
                      description: Type is the channel type.
                      type: string
                  required:
                  - status
                  - type
                  type: object
                type: array
              conditions:
                description: Conditions represent the latest available observations
                  of an object's state.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              phase:
                description: Phase is the current phase (Pending, Running, Error).
                type: string
              totalAgentRuns:
                description: TotalAgentRuns is the total number of agent runs for
                  this instance.
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
